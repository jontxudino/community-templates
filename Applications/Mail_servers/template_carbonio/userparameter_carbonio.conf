# =============================================================================
# Carbonio Zabbix UserParameter Configuration
# Para Ubuntu 24.04+ (systemctl en lugar de zmcontrol)
# =============================================================================
# Ubicación: /etc/zabbix/zabbix_agent2.d/userparameter_carbonio.conf
# 
# INSTALACIÓN:
# 1. Copiar este archivo a /etc/zabbix/zabbix_agent2.d/
# 2. Copiar scripts a /etc/zabbix/scripts/carbonio/
# 3. Configurar sudoers (ver abajo)
# 4. Reiniciar agente: systemctl restart zabbix-agent2
#
# SUDOERS (añadir a /etc/sudoers.d/zabbix):
#   zabbix ALL=(ALL) NOPASSWD: /usr/bin/systemctl status carbonio-*
#   zabbix ALL=(ALL) NOPASSWD: /usr/bin/systemctl is-active carbonio-*
#   zabbix ALL=(ALL) NOPASSWD: /usr/sbin/postqueue
#   zabbix ALL=(ALL) NOPASSWD: /opt/zextras/common/sbin/mailq
#   zabbix ALL=(ALL) NOPASSWD: /opt/zextras/bin/carbonio
#   zabbix ALL=(ALL) NOPASSWD: /etc/zabbix/scripts/carbonio/*.sh
# =============================================================================

# =============================================================================
# ESTADO DE SERVICIOS (SYSTEMCTL)
# Devuelve 0 si activo, 1 si no activo
# =============================================================================

# Servicios individuales
UserParameter=carbonio.antivirus.status,systemctl is-active carbonio-antivirus.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.freshclam.status,systemctl is-active carbonio-freshclam.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.mailthreat.status,systemctl is-active carbonio-mailthreat.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.policyd.status,systemctl is-active carbonio-policyd.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.configd.status,systemctl is-active carbonio-configd.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.memcached.status,systemctl is-active carbonio-memcached.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.nginx.status,systemctl is-active carbonio-nginx.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.opendkim.status,systemctl is-active carbonio-opendkim.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.openldap.status,systemctl is-active carbonio-openldap.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.postfix.status,systemctl is-active carbonio-postfix.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.appserver.status,systemctl is-active carbonio-appserver.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.appserverdb.status,systemctl is-active carbonio-appserver-db.service >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.stats.status,systemctl is-active carbonio-stats.service >/dev/null 2>&1 && echo 0 || echo 1

# Targets (grupos de servicios)
UserParameter=carbonio.target.mta.status,systemctl is-active carbonio-mta.target >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.target.proxy.status,systemctl is-active carbonio-proxy.target >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.target.appserver.status,systemctl is-active carbonio-appserver.target >/dev/null 2>&1 && echo 0 || echo 1
UserParameter=carbonio.target.directory.status,systemctl is-active carbonio-directory-server.target >/dev/null 2>&1 && echo 0 || echo 1

# Número de servicios carbonio activos
UserParameter=carbonio.services.active,systemctl list-units --type=service --state=active 2>/dev/null | grep -c "carbonio-" || echo 0

# =============================================================================
# COLAS DE CORREO (POSTFIX)
# =============================================================================

# Cola total (método simple con mailq)
UserParameter=carbonio.mailq.total,/opt/zextras/common/sbin/mailq 2>/dev/null | grep -v "Mail queue is empty" | grep -c '^[0-9A-F]' || echo 0

# Colas detalladas
UserParameter=carbonio.mailq.active,/opt/zextras/common/sbin/postqueue -p 2>/dev/null | grep -c "^[0-9A-F].*\*" || echo 0
UserParameter=carbonio.mailq.deferred,find /opt/zextras/data/postfix/spool/deferred -type f 2>/dev/null | wc -l || echo 0
UserParameter=carbonio.mailq.hold,find /opt/zextras/data/postfix/spool/hold -type f 2>/dev/null | wc -l || echo 0
UserParameter=carbonio.mailq.corrupt,find /opt/zextras/data/postfix/spool/corrupt -type f 2>/dev/null | wc -l || echo 0
UserParameter=carbonio.mailq.incoming,find /opt/zextras/data/postfix/spool/incoming -type f 2>/dev/null | wc -l || echo 0

# =============================================================================
# ESTADÍSTICAS DE CORREO (del log de Postfix)
# Estas métricas requieren el script carbonio_mailstats.sh
# =============================================================================

UserParameter=carbonio.mail.bytes.sent,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh bytes_sent
UserParameter=carbonio.mail.bytes.received,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh bytes_received
UserParameter=carbonio.mail.sent,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh sent
UserParameter=carbonio.mail.received,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh received
UserParameter=carbonio.mail.rejected,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh rejected
UserParameter=carbonio.mail.bounced,/etc/zabbix/scripts/carbonio/carbonio_mailstats.sh bounced

# =============================================================================
# ANTI-SPAM / RBL BLOCKS (del log de Postfix)
# Estas métricas requieren el script carbonio_rblstats.sh
# =============================================================================

UserParameter=carbonio.rbl.spamhaus.zen,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh zen.spamhaus.org
UserParameter=carbonio.rbl.spamhaus.dbl,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh dbl.spamhaus.org
UserParameter=carbonio.rbl.spamcop,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh bl.spamcop.net
UserParameter=carbonio.rbl.barracuda,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh b.barracudacentral.org
UserParameter=carbonio.rbl.psbl,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh psbl.surriel.com
UserParameter=carbonio.rbl.reverse.dns,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh reverse_hostname
UserParameter=carbonio.reject.helo.invalid,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh helo_invalid
UserParameter=carbonio.reject.helo.notfound,/etc/zabbix/scripts/carbonio/carbonio_rblstats.sh helo_notfound

# =============================================================================
# ESPACIO EN DISCO Y ALMACENAMIENTO
# Ruta por defecto: /opt/zextras/store
# Para usar otra ruta, modificar directamente aquí o usar el parámetro con argumento
# =============================================================================

UserParameter=carbonio.store.used,df -B1 /opt/zextras/store 2>/dev/null | tail -1 | awk '{print $3}' || echo 0
UserParameter=carbonio.store.free,df -B1 /opt/zextras/store 2>/dev/null | tail -1 | awk '{print $4}' || echo 0
UserParameter=carbonio.store.pused,df /opt/zextras/store 2>/dev/null | tail -1 | awk '{gsub(/%/,""); print $5}' || echo 0

# =============================================================================
# CONEXIONES ACTIVAS
# =============================================================================

UserParameter=carbonio.connections.imap,ss -tn state established 2>/dev/null | grep -c ":993\|:143" || echo 0
UserParameter=carbonio.connections.pop3,ss -tn state established 2>/dev/null | grep -c ":995\|:110" || echo 0
UserParameter=carbonio.connections.smtp,ss -tn state established 2>/dev/null | grep -c ":25\|:465\|:587" || echo 0
UserParameter=carbonio.connections.http,ss -tn state established 2>/dev/null | grep -c ":80\|:443" || echo 0

# =============================================================================
# CUENTAS Y DOMINIOS
# =============================================================================

UserParameter=carbonio.accounts.total,/etc/zabbix/scripts/carbonio/carbonio_accounts.sh total
UserParameter=carbonio.accounts.active,/etc/zabbix/scripts/carbonio/carbonio_accounts.sh active
UserParameter=carbonio.domains.total,/etc/zabbix/scripts/carbonio/carbonio_accounts.sh domains

# =============================================================================
# VERSIÓN Y UPTIME
# =============================================================================

UserParameter=carbonio.version,dpkg -l carbonio-core 2>/dev/null | grep carbonio-core | awk '{print $3}' || echo "unknown"
UserParameter=carbonio.uptime.appserver,/etc/zabbix/scripts/carbonio/carbonio_uptime.sh appserver
